<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Hold'em Casino - ì‹¤ì‹œê°„</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <style>
        :root { --felt: #1a472a; --gold: #f1c40f; --orange: #e67e22; }
        body { 
            font-family: 'Malgun Gothic', sans-serif; 
            background: #0f0f0f; 
            color: white; 
            margin: 0; 
            display: flex;
            flex-direction: column;
            justify-content: center; 
            align-items: center;     
            min-height: 100vh;       
            overflow-x: hidden;      
        }
        
        /* í¬ì»¤ í…Œì´ë¸” ì™¸í˜• */
        .poker-arena {
            position: relative; 
            width: 950px; 
            height: 500px; 
            background: var(--felt);
            border: 12px solid #3e2723; 
            border-radius: 250px; 
            margin: 50px 0;
            display: flex; 
            justify-content: center; 
            align-items: center;
            box-shadow: inset 0 0 50px rgba(0,0,0,0.5);
        }

        /* ìŠ¹ì ë°œí‘œ ë°°ë„ˆ */
        .winner-banner {
            position: absolute; 
            top: 20px; /* ê¸°ì¡´ -200pxì—ì„œ í™”ë©´ ì•ˆìœ¼ë¡œ ìˆ˜ì •ë¨ */
            background: var(--gold); 
            color: black; 
            padding: 10px 40px; 
            border-radius: 30px; 
            font-weight: bold; 
            font-size: 1.5em; 
            z-index: 100;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }

        /* í”Œë ˆì´ì–´ ì¢Œì„ ë°°ì¹˜ */
        .player-seat {
            position: absolute; width: 170px; background: rgba(0,0,0,0.85);
            padding: 12px; border-radius: 15px; border: 2px solid #444; transition: 0.3s;
            z-index: 10;
        }
        .active { border-color: var(--orange); box-shadow: 0 0 20px var(--orange); transform: scale(1.05); }
        .folded { opacity: 0.4; }

        .seat-0 { bottom: -70px; left: 390px; } 
        .seat-3 { top: -70px; left: 390px; } 
        .seat-1 { bottom: 20px; left: -30px; } 
        .seat-2 { top: 20px; left: -30px; } 
        .seat-4 { top: 20px; right: -30px; } 
        .seat-5 { bottom: 20px; right: -30px; }

        .p-name { font-size: 1.1em; font-weight: bold; margin-bottom: 5px; border-bottom: 1px solid #555; }
        .p-chips { color: var(--gold); font-weight: bold; }
        
        /* ì¹´ë“œ ê³µí†µ ìŠ¤íƒ€ì¼ */
        .card { 
            display: inline-block; 
            background: white; 
            width: 35px; 
            height: 50px; 
            border-radius: 4px; 
            margin: 2px; 
            font-size: 1.1em; 
            line-height: 50px; 
            font-weight: bold; 
            text-align: center;
            box-shadow: 1px 1px 3px rgba(0,0,0,0.3);
        } 

        .community-card {
            width: 80px; height: 120px; font-size: 2.2em; line-height: 120px;
            margin: 5px; border-radius: 8px; box-shadow: 2px 2px 10px rgba(0,0,0,0.3);
        }

        /* ë¬¸ì–‘ë³„ ìƒ‰ìƒ */
        .red { color: #e74c3c !important; } 
        .black { color: #2c3e50 !important; }

        .table-center { text-align: center; }
        .pot-display { font-size: 1.2em; color: var(--gold); margin-bottom: 10px; font-weight: bold; }

        /* í•˜ë‹¨ ì»¨íŠ¸ë¡¤ ë°” */
        .control-bar { 
            background: #222; 
            width: 100%; 
            max-width: 950px; 
            padding: 25px; 
            border-radius: 15px; 
            margin: 100px auto 30px auto; 
            text-align: center;
        }
        .btn { padding: 12px 24px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; color: white; display: inline-block; font-size: 1em; margin: 0 5px; }
    </style>
</head>
<body>
    
    <div class="poker-arena">
        {% if winner_result %}
            <div class="winner-banner">ğŸ† {{ winner_result }}</div>
        {% endif %}

        <div class="table-center">
            <div class="pot-display">POT: ${{ pot }}</div>
            {% for card in community %}
                <div class="card community-card {% if 'â™¥' in card|string or 'â™¦' in card|string %}red{% else %}black{% endif %}">
                    {{ card }}
                </div>
            {% endfor %}
        </div>

        {% for p in players %}
            {% set is_turn = (loop.index0 == turn_idx % players|length and not winner_result and p.hand) %}
            <div class="player-seat seat-{{ loop.index0 }} {{'active' if is_turn else '' }} {{ 'folded' if p.is_folded else '' }}">
                <div class="p-name">
                    {% if p.pos_name %}<span style="background:var(--gold); color:black; padding:0 5px; border-radius:50%; font-size:0.7em;">{{ p.pos_name }}</span>{% endif %}
                    {{ p.name }}
                    {% if p.round_profit != 0 %}
                        <span style="font-size: 0.85em; margin-left: 5px; font-weight: bold; color: {{ '#2ecc71' if p.round_profit > 0 else '#e74c3c' }};">
                        ({{ '+' if p.round_profit > 0 }}{{ p.round_profit }})
                        </span>
                    {% endif %}
                </div>
                <div class="p-chips">${{ p.chips }}</div>
                <div class="p-total-bet">Bet({{ p.status }}): ${{ p.bet_this_round }}</div>
                {% if p.hand %}
                    <div style="margin-top: 5px;">
                    {% for card in p.hand %}
                        <div class="card {% if 'â™¥' in card|string or 'â™¦' in card|string %}red{% else %}black{% endif %}">
                            {{ card }}
                        </div>
                    {% endfor %}
                    </div>
                {% endif %}
            </div>
        {% endfor %}
    </div>

    <div class="control-bar">
        {% if players|length >= 2 %}
            {% if not players[0].hand or winner_result %}
                <button id="deal_button" onclick="startGame()" class="btn" style="display: none; background: #27ae60; font-size: 1.2em;">DEAL NEW HAND</button>
            {% else %}
                <div style="display: flex; gap: 10px; justify-content: center; align-items: center;">
                    <button onclick="sendAction('call')" class="btn" style="background: var(--orange);">CALL / CHECK</button>
                    <button onclick="sendAction('fold')" class="btn" style="background: var(--orange);">FOLD</button>
                    <button onclick="sendAction('allin')" class="btn" style="background: var(--orange);">ALL-IN</button>

                    {% set min_r = [high_bet * 2, 200]|max %}
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <input type="number" step="50" id="ra" value="{{ min_r }}" min="{{ min_r }}" style="padding: 10px; width: 80px; border-radius: 5px; border: none;">
                        <button onclick="sendAction('raise', document.getElementById('ra').value)" class="btn" style="background:#d35400;">RAISE</button>
                    </div>
                </div>
            {% endif %}
        {% endif %}

        <div id="join_section" style="margin-top: 20px;">
            <input type="text" id="new_player_name" placeholder="ë‹‰ë„¤ì„ ì…ë ¥" style="padding: 10px; border-radius: 5px; border: none;">
            <button onclick="joinGame()" class="btn" style="background: #27ae60;">ê²Œì„ ì°¸ê°€ (Join)</button>
        </div>
    </div>

    <script>
    var socket = io();
    var myName = localStorage.getItem('poker_name');

    // 1. ì„œë²„ë¡œë¶€í„° ê°€ì… ì„±ê³µ ì‹œ ê³ ìœ  ID(UUID)ë¥¼ ë°›ì•„ ì„¸ì…˜ì— ì €ì¥
    socket.on('join_success', function(data) {
        sessionStorage.setItem('poker_player_uuid', data.p_uuid);
    });

    // 2. ì„œë²„ì˜ ê²Œì„ ìƒíƒœ ì—…ë°ì´íŠ¸ ìˆ˜ì‹ 
    socket.on('update_game', function(data) {
    console.log("ì‹¤ì‹œê°„ ë°ì´í„° ìˆ˜ì‹ :", data);
    
    // 1. í˜ì´ì§€ ì „ì²´ë¥¼ ìƒˆë¡œê³ ì¹¨(reload)í•˜ëŠ” ëŒ€ì‹ , 
    //    ì´ë¯¸ ë§Œë“¤ì–´ë‘” syncGameState í•¨ìˆ˜ë§Œ ì‹¤í–‰í•´ì„œ í™”ë©´ì„ ê°±ì‹ í•©ë‹ˆë‹¤.
    syncGameState(data.players, data.turn_idx, data.winner_result);
    
    // 2. (ì¶”ê°€) í•„ìš”í•œ ê²½ìš° ì¹´ë“œë‚˜ íŒŸ(Pot) ê¸ˆì•¡ë„ JSë¡œ ì—…ë°ì´íŠ¸í•˜ëŠ” ë¡œì§ì„ ì—¬ê¸°ì— ë„£ìœ¼ë©´ ë©ë‹ˆë‹¤.
    document.querySelector('.pot-display').innerText = `POT: $${data.pot}`;
    });

    // 3. UI ì œì–´: ë‚´ ì¹´ë“œë§Œ ë³´ì—¬ì£¼ê³ , ë‚´ ì°¨ë¡€ê°€ ì•„ë‹ˆë©´ ë² íŒ… ì°¨ë‹¨
    function syncGameState(players, turnIdx, winnerResult) {
        const myUuid = sessionStorage.getItem('poker_player_uuid');
        
        // (A) ê°€ì…ì°½ ì œì–´
        const joinSection = document.getElementById('join_section');
        if (joinSection) {
            const isAlreadyJoined = players.some(p => p.uuid === myUuid);
            joinSection.style.display = isAlreadyJoined ? 'none' : 'block';
        }
        // (B) ë°©ì¥(ì²« ë²ˆì§¸ í”Œë ˆì´ì–´) ì „ìš© ë²„íŠ¼ ì œì–´ ë¡œì§ ì¶”ê°€
        const dealBtn = document.getElementById('deal_button');
        if (dealBtn && players.length > 0) {
        // 1. ì²« ë²ˆì§¸ í”Œë ˆì´ì–´ì˜ UUIDì™€ ë‚´ UUIDê°€ ì¼ì¹˜í•˜ëŠ”ì§€ í™•ì¸
        const isHost = players[0].uuid === myUuid;
        
        // 2. ê²Œì„ì´ ëë‚¬ê±°ë‚˜ ì•„ì§ ì‹œì‘ ì „ì¸ì§€ í™•ì¸
        const needsNewHand = !players[0].hand || players[0].hand.length === 0 || winnerResult;

        // ë°©ì¥ì´ê³  ìƒˆ ê²Œì„ì´ í•„ìš”í•œ ìƒíƒœë¼ë©´ ë²„íŠ¼ í‘œì‹œ
        if (isHost && needsNewHand) {
            dealBtn.style.display = 'inline-block';
        } else {
            dealBtn.style.display = 'none';
        }
    }
        // (B) ë‚´ ì°¨ë¡€ê°€ ì•„ë‹ˆë©´ ì»¨íŠ¸ë¡¤ ë°” ë¹„í™œì„±í™”
        const controlBar = document.querySelector('.control-bar');
        if (controlBar && players.length > 0) {
            const currentTurnPlayer = players[turnIdx % players.length];
            const isMyTurn = currentTurnPlayer && currentTurnPlayer.uuid === myUuid;
            
            // ê²°ê³¼ê°€ ë‚˜ì™”ì„ ë•ŒëŠ” ë‹¤ì‹œ ë²„íŠ¼ í™œì„±í™”(ìƒˆ ê²Œì„ ì‹œì‘ìš©), í‰ì†Œì—ëŠ” ë‚´ ì°¨ë¡€ì¼ ë•Œë§Œ í™œì„±í™”
            if (!winnerResult && players[0].hand.length > 0) {
                controlBar.style.opacity = isMyTurn ? "1" : "0.3";
                controlBar.style.pointerEvents = isMyTurn ? "auto" : "none";
            } else {
                controlBar.style.opacity = "1";
                controlBar.style.pointerEvents = "auto";
            }
        }

        // (C) ì¹´ë“œ ë§ˆìŠ¤í‚¹ (ì•ˆê°œ ì‹œìŠ¤í…œ)
        document.querySelectorAll('.player-seat').forEach((seat, index) => {
            const p = players[index];
            if (!p || !p.hand) return;

            const cardElements = seat.querySelectorAll('.card');
            cardElements.forEach(card => {
                // ë³´ì—¬ì£¼ëŠ” ì¡°ê±´: 1.ë‚´ ì¹´ë“œì´ê±°ë‚˜ 2.ì‡¼ë‹¤ìš´ ìƒí™©ì¸ë° ê¸°ê¶Œí•˜ì§€ ì•Šì€ í”Œë ˆì´ì–´ì¸ ê²½ìš°
                const shouldShow = (p.uuid === myUuid) || (winnerResult && !p.is_folded);
                
                if (!shouldShow) {
                    card.innerText = '??';
                    card.style.background = '#34495e'; // ì¹´ë“œ ë’·ë©´ ìƒ‰ìƒ
                    card.style.color = '#34495e';      // ê¸€ì ìˆ¨ê¸°ê¸°
                    card.classList.remove('red', 'black');
                }
            });
        });
    }

    // 4. ê°€ì… ìš”ì²­ (ê¸°ì¡´ UUID í¬í•¨)
    function joinGame() {
        const nameInput = document.getElementById('new_player_name');
        const name = nameInput.value.trim();
        const existingUuid = sessionStorage.getItem('poker_player_uuid');
        
        if (name) {
            localStorage.setItem('poker_name', name);
            socket.emit('join_game', {
                player_name: name,
                p_uuid: existingUuid
            });
        }
    }

    // 5. ê²Œì„ ì‹œì‘ ìš”ì²­
    function startGame() {
        socket.emit('start_game');
    }

    // 6. ì•¡ì…˜ ì „ì†¡ ì‹œ ë³´ì•ˆì„ ìœ„í•´ UUID í¬í•¨
    function sendAction(actionType, amount = 0) {
        const myUuid = sessionStorage.getItem('poker_player_uuid');
        socket.emit('player_action', {
            type: actionType,
            amount: amount,
            p_uuid: myUuid // ì„œë²„ê°€ "ì§„ì§œ ë³¸ì¸"ì¸ì§€ í™•ì¸í•˜ëŠ” ìš©ë„
        });
    }

    // 7. í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™” ë° ë™ê¸°í™”
    window.onload = () => {
        window.isReloading = false; 
        try {
            // Jinja2 ë°ì´í„°ë¥¼ JS ê°ì²´ë¡œ ë³€í™˜
            const playersDataRaw = '{{ players|tojson|safe }}';
            const currentPlayers = JSON.parse(playersDataRaw);
            const turnIdx = {{ turn_idx }};
            const winnerResult = '{{ winner_result or "" }}';

            // í™”ë©´ ì´ˆê¸° ìƒíƒœ ë™ê¸°í™”
            syncGameState(currentPlayers, turnIdx, winnerResult);
        } catch (e) {
            console.error("ë™ê¸°í™” ì‹¤íŒ¨:", e);
        }
    };
</script>
</body>
</html>
