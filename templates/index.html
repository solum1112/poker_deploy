<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Hold'em Casino - Realtime</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <style>
        :root { --felt: #1a472a; --gold: #f1c40f; --orange: #e67e22; }
        body { font-family: 'Malgun Gothic', sans-serif; background: #0f0f0f; color: white; margin: 0; display: flex; flex-direction: column; justify-content: center; align-items: center; min-height: 100vh; overflow-x: hidden; }
        .poker-arena { position: relative; width: 950px; height: 500px; background: var(--felt); border: 12px solid #3e2723; border-radius: 250px; margin: 50px 0; display: flex; justify-content: center; align-items: center; box-shadow: inset 0 0 50px rgba(0,0,0,0.5); }
        .winner-banner { position: absolute; top: 20px; background: var(--gold); color: black; padding: 10px 40px; border-radius: 30px; font-weight: bold; font-size: 1.5em; z-index: 100; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
        .player-seat { position: absolute; width: 170px; background: rgba(0,0,0,0.85); padding: 12px; border-radius: 15px; border: 2px solid #444; transition: 0.3s; z-index: 10; }
        .active { border-color: var(--orange); box-shadow: 0 0 20px var(--orange); transform: scale(1.05); }
        .folded { opacity: 0.4; }
        .seat-0 { bottom: -70px; left: 390px; } .seat-3 { top: -70px; left: 390px; } 
        .seat-1 { bottom: 20px; left: -30px; } .seat-2 { top: 20px; left: -30px; } 
        .seat-4 { top: 20px; right: -30px; } .seat-5 { bottom: 20px; right: -30px; }
        .p-name { font-size: 1.1em; font-weight: bold; margin-bottom: 5px; border-bottom: 1px solid #555; }
        .p-chips { color: var(--gold); font-weight: bold; }
        .card { display: inline-block; background: white; width: 35px; height: 50px; border-radius: 4px; margin: 2px; font-size: 1.1em; line-height: 50px; font-weight: bold; text-align: center; box-shadow: 1px 1px 3px rgba(0,0,0,0.3); color: #2c3e50;} 
        .community-card { width: 80px; height: 120px; font-size: 2.2em; line-height: 120px; margin: 5px; border-radius: 8px; }
        .red { color: #e74c3c !important; } .black { color: #2c3e50 !important; }
        .pot-display { font-size: 1.2em; color: var(--gold); margin-bottom: 10px; font-weight: bold; text-align: center;}
        .control-bar { background: #222; width: 100%; max-width: 950px; padding: 25px; border-radius: 15px; margin-bottom: 30px; text-align: center; }
        .btn { padding: 12px 24px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; color: white; font-size: 1em; margin: 0 5px; }
    </style>
</head>
<body>
    <div class="poker-arena">
        <div id="winner_ui"></div>
        <div class="table-center">
            <div id="pot_ui" class="pot-display">POT: $0</div>
            <div id="community_ui"></div>
        </div>
        <div id="players_ui"></div>
    </div>

    <div class="control-bar">
        <div id="action_ui"></div>
        <button id="deal_button" onclick="startGame()" class="btn" style="display: none; background: #27ae60;">DEAL NEW HAND</button>
        <button id="reset_button" onclick="resetGame()" class="btn" style="display: none; background: #c0392b;">Ï†ÑÏ≤¥ Ïπ© Ï¥àÍ∏∞Ìôî (RESET)</button>
        <div id="join_section" style="margin-top: 20px;">
            <input type="text" id="new_player_name" placeholder="ÎãâÎÑ§ÏûÑ ÏûÖÎ†•" style="padding: 10px; border-radius: 5px;">
            <button onclick="joinGame()" class="btn" style="background: #27ae60;">Í≤åÏûÑ Ï∞∏Í∞Ä</button>
        </div>
    </div>

    <script>
    var socket = io();
    var myUuid = sessionStorage.getItem('poker_player_uuid');

    socket.on('join_success', function(data) {
        myUuid = data.p_uuid;
        sessionStorage.setItem('poker_player_uuid', data.p_uuid);
    });

    socket.on('update_game', function(data) {
        // Î¨¥Ìïú ÏÉàÎ°úÍ≥†Ïπ® Î∞©ÏßÄ: DOM ÏßÅÏ†ë ÏóÖÎç∞Ïù¥Ìä∏
        syncGameState(data.players, data.turn_idx, data.winner_result);
        updateBoard(data.community, data.pot, data.winner_result);
    });

    function syncGameState(players, turnIdx, winnerResult) {
        const isHost = players.length > 0 && players[0].uuid === myUuid;
        
        // Î≤ÑÌäº Ï†úÏñ¥
        const dealBtn = document.getElementById('deal_button');
        const resetBtn = document.getElementById('reset_button');
        const needsNewHand = players.length >= 2 && (!players[0].hand || players[0].hand.length === 0 || winnerResult);
        
        if (dealBtn) dealBtn.style.display = (isHost && needsNewHand) ? 'inline-block' : 'none';
        if (resetBtn) resetBtn.style.display = (isHost && (winnerResult || players.filter(p => p.chips > 0).length < 2)) ? 'inline-block' : 'none';

        // Í∞ÄÏûÖÏ∞Ω Ï†úÏñ¥
        document.getElementById('join_section').style.display = players.some(p => p.uuid === myUuid) ? 'none' : 'block';

        // ÌîåÎ†àÏù¥Ïñ¥ Ï¢åÏÑù Î†åÎçîÎßÅ
        let html = '';
        players.forEach((p, i) => {
            const isTurn = (i === turnIdx % players.length && !winnerResult && p.hand && p.hand.length > 0);
            html += `<div class="player-seat seat-${i} ${isTurn ? 'active' : ''} ${p.is_folded ? 'folded' : ''}">
                <div class="p-name">${p.pos_name ? `<span style="background:var(--gold);color:black;padding:0 5px;border-radius:50%;font-size:0.7em;">${p.pos_name}</span>` : ''} ${p.name}</div>
                <div class="p-chips">$${p.chips}</div>
                <div class="p-total-bet">Bet(${p.status}): $${p.bet_this_round}</div>
                <div style="margin-top: 5px;">${renderHand(p, winnerResult)}</div>
            </div>`;
        });
        document.getElementById('players_ui').innerHTML = html;

        // Ïï°ÏÖò Î∞î Ï†úÏñ¥
        renderActionButtons(players, turnIdx, winnerResult);
    }

    function renderHand(p, winnerResult) {
        if (!p.hand || p.hand.length === 0) return '';
        return p.hand.map((card, idx) => {
            const shouldShow = (p.uuid === myUuid) || (winnerResult && !p.is_folded);
            if (!shouldShow) return `<div class="card" style="background:#34495e; color:#34495e;">??</div>`;
            const colorClass = (card.includes('‚ô•') || card.includes('‚ô¶')) ? 'red' : 'black';
            return `<div class="card ${colorClass}">${card}</div>`;
        }).join('');
    }

    function renderActionButtons(players, turnIdx, winnerResult) {
        const container = document.getElementById('action_ui');
        const currentP = players[turnIdx % players.length];
        if (!winnerResult && currentP && currentP.uuid === myUuid && currentP.hand.length > 0) {
            container.innerHTML = `
                <div style="display: flex; gap: 10px; justify-content: center; align-items: center;">
                    <button onclick="sendAction('call')" class="btn" style="background: var(--orange);">CALL / CHECK</button>
                    <button onclick="sendAction('fold')" class="btn" style="background: var(--orange);">FOLD</button>
                    <button onclick="sendAction('allin')" class="btn" style="background: var(--orange);">ALL-IN</button>
                    <input type="number" step="50" id="ra_val" value="400" style="padding: 10px; width: 80px; border-radius: 5px;">
                    <button onclick="sendAction('raise', document.getElementById('ra_val').value)" class="btn" style="background:#d35400;">RAISE</button>
                </div>`;
        } else {
            container.innerHTML = '';
        }
    }

    function updateBoard(community, pot, winner) {
        document.getElementById('pot_ui').innerText = `POT: $${pot}`;
        document.getElementById('winner_ui').innerHTML = winner ? `<div class="winner-banner">üèÜ ${winner}</div>` : '';
        document.getElementById('community_ui').innerHTML = community.map(card => {
            const colorClass = (card.includes('‚ô•') || card.includes('‚ô¶')) ? 'red' : 'black';
            return `<div class="card community-card ${colorClass}">${card}</div>`;
        }).join('');
    }

    function joinGame() {
        const name = document.getElementById('new_player_name').value.trim();
        if (name) socket.emit('join_game', { player_name: name, p_uuid: myUuid });
    }
    function startGame() { socket.emit('start_game'); }
    function resetGame() { if(confirm("Ï¥àÍ∏∞ÌôîÌï†ÍπåÏöî?")) socket.emit('reset_game'); }
    function sendAction(type, amt = 0) { socket.emit('player_action', { type: type, amount: amt, p_uuid: myUuid }); }
    </script>
</body>
</html>
